<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Upload via Proxy Vite</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .test-section { background: #f3f4f6; padding: 20px; border-radius: 10px; margin: 20px 0; }
        .success { background: #10b981; color: white; padding: 15px; border-radius: 8px; }
        .error { background: #ef4444; color: white; padding: 15px; border-radius: 8px; }
        .info { background: #3b82f6; color: white; padding: 15px; border-radius: 8px; }
        button { background: #3b82f6; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; margin: 5px; }
        button:hover { background: #2563eb; }
        input[type="file"] { margin: 10px 0; }
        #results { margin-top: 20px; }
    </style>
</head>
<body>
    <h1>üß™ Test Upload Image Profil - Via Proxy Vite</h1>
    
    <div class="info">
        <h3>üìã Instructions</h3>
        <p>1. <strong>D√©marrez le frontend</strong>: <code>npm run dev</code> dans micro-challenge-frontend</p>
        <p>2. <strong>Ouvrez cette page via Vite</strong>: <code>http://localhost:5173/test-proxy-upload.html</code></p>
        <p>3. <strong>Connectez-vous</strong> puis testez l'upload</p>
    </div>

    <div class="test-section">
        <h2>üîê √âtape 1: Connexion</h2>
        <p>Email: admin@satoripop.com | Mot de passe: admin123</p>
        <button onclick="login()">Se connecter</button>
        <div id="loginResult"></div>
    </div>

    <div class="test-section">
        <h2>üì§ √âtape 2: Upload d'image</h2>
        <input type="file" id="imageInput" accept="image/*">
        <button onclick="uploadImage()">Uploader l'image</button>
        <div id="uploadResult"></div>
    </div>

    <div id="results"></div>

    <script>
        let authToken = null;

        async function login() {
            const loginResult = document.getElementById('loginResult');
            loginResult.innerHTML = '‚è≥ Connexion en cours...';
            
            try {
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        email: 'admin@satoripop.com',
                        password: 'admin123'
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    authToken = data.token;
                    loginResult.innerHTML = '<div class="success">‚úÖ Connexion r√©ussie ! Token: ' + authToken.substring(0, 20) + '...</div>';
                } else {
                    const error = await response.json();
                    loginResult.innerHTML = '<div class="error">‚ùå Erreur de connexion: ' + error.msg + '</div>';
                }
            } catch (error) {
                loginResult.innerHTML = '<div class="error">‚ùå Erreur r√©seau: ' + error.message + '</div>';
            }
        }

        async function uploadImage() {
            const uploadResult = document.getElementById('uploadResult');
            const imageInput = document.getElementById('imageInput');
            
            if (!authToken) {
                uploadResult.innerHTML = '<div class="error">‚ùå Veuillez d\'abord vous connecter</div>';
                return;
            }

            if (!imageInput.files[0]) {
                uploadResult.innerHTML = '<div class="error">‚ùå Veuillez s√©lectionner une image</div>';
                return;
            }

            uploadResult.innerHTML = '‚è≥ Upload en cours...';
            
            try {
                const formData = new FormData();
                formData.append('profileImage', imageInput.files[0]);

                console.log('üöÄ Upload vers: /api/users/profile-image (proxy Vite)');
                
                const response = await fetch('/api/users/profile-image', {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: formData
                });

                console.log('üìä Status:', response.status);
                console.log('üìã Content-Type:', response.headers.get('content-type'));

                if (response.ok) {
                    const result = await response.json();
                    uploadResult.innerHTML = '<div class="success">‚úÖ UPLOAD R√âUSSI !<br>Image: ' + result.profileImage + '</div>';
                    console.log('‚úÖ Succ√®s:', result);
                } else {
                    const contentType = response.headers.get('content-type');
                    if (contentType && contentType.includes('application/json')) {
                        const error = await response.json();
                        uploadResult.innerHTML = '<div class="error">‚ùå Erreur JSON: ' + error.msg + '</div>';
                    } else {
                        const textError = await response.text();
                        uploadResult.innerHTML = '<div class="error">‚ùå Erreur HTML re√ßue (au lieu de JSON):<br>' + textError.substring(0, 200) + '...</div>';
                        console.error('üö® HTML re√ßu:', textError);
                    }
                }
            } catch (error) {
                uploadResult.innerHTML = '<div class="error">‚ùå Erreur: ' + error.message + '</div>';
                console.error('‚ùå Erreur catch:', error);
            }
        }
    </script>
</body>
</html>